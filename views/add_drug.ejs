<!-- add header -->
<%- include('includes/_header') %>
    <!-- end header -->
    <!-- Main section -->
    <main id="main">
        <a href="/">
            <span><i class="fas fa-arrow-left"></i> All Drugs</span>
        </a>

        <h2>Add a Drug</h2>
        <p>Use the below form to add a new drug</p>
        <!-- Add drug form -->
        <form action="/api/drugs" method="POST" id="add_drug">
            <div class="container d-flex flex-column align-items-stretch">
                <div class="row mb-3 form-group justify-content-center">
                    <label for="name" class="col-3 col-form-label">Drug Name</label>
                    <input type="hidden" name="id" value="">
                    <input type="text" id="name" name="name" value="" placeholder="Drug Name" class="col-md-4 col-xs-8"
                        required>
                </div>
                <div class="row mb-3 form-group justify-content-center">
                    <label for="card" class="col-3 col-form-label">Tablets per Card</label>
                    <input type="number" id="card" name="card" value="" placeholder="Tablets per Card" min="1"
                        max="10000" class="col-xs-8 col-md-4" required>
                </div>
                <div class="row mb-3 form-group justify-content-center">
                    <label for="pack" class="col-3 col-form-label">Tablets per Pack</label>
                    <input type="number" id="pack" name="pack" value="" placeholder="Tablets per Pack" min="1"
                        max="1000" class="col-xs-8 col-md-4" required>
                </div>
                <div class="row form-group mb-3 justify-content-center">
                    <label for="perDay" class="col-3 col-form-label">Taken per day</label>
                    <input type="number" id="perDay" name="perDay" value="" placeholder="Taken per day" min="1" max="89"
                        class="col-xs-8 col-md-4" required>
                </div>
                <div class="row mb-3 form-group justify-content-center">
                    <label for="dosage" class="col-3 col-form-label">Dosage</label>
                    <input type="hidden" name="id" value="">
                    <input type="text" id="dosage" name="dosage" value="" placeholder="Dosage" class="col-md-4 col-xs-8"
                        required>
                </div>
                <div class="form-group">
                    <button type="submit">Add Drug</button>
                </div>
            </div>
        </form>
    </main>
    <!-- End main section -->
    <!-- add footer -->
    <%- include('includes/_footer') %>
        <!-- end footer -->
        <script>
            // assets/js/main.js - Thêm hoặc sửa
            $(document).ready(function () {
                // Bắt sự kiện submit form
                $('#add_drug').on('submit', function (e) {
                    e.preventDefault(); // Ngăn form submit bình thường

                    // Lấy dữ liệu form
                    const formData = {
                        name: $('input[name="name"]').val(),
                        card: parseInt($('input[name="card"]').val()),
                        pack: parseInt($('input[name="pack"]').val()),
                        perDay: parseInt($('input[name="perDay"]').val()),
                        dosage: $('input[name="dosage"]').val()
                    };

                    // Gửi AJAX request
                    $.ajax({
                        url: '/api/drugs',
                        method: 'POST',
                        data: JSON.stringify(formData),
                        contentType: 'application/json',
                        success: function (response) {
                            // Thành công
                            alert('Drug added successfully!');
                            // Redirect về trang chủ
                            window.location.href = '/';
                        },
                        error: function (xhr, status, error) {
                            // Bắt lỗi từ middleware
                            try {
                                const errorResponse = JSON.parse(xhr.responseText);

                                // Hiển thị lỗi validation
                                if (errorResponse.message) {
                                    showError(errorResponse.message);
                                } else {
                                    showError('An error occurred while adding drug');
                                }
                            } catch (e) {
                                showError('An unexpected error occurred');
                            }
                        }
                    });
                });

                // Hàm hiển thị lỗi
                function showError(message) {
                    // Xóa lỗi cũ nếu có
                    $('.error-message').remove();

                    // Tạo div hiển thị lỗi
                    const errorDiv = `
            <div class="error-message alert alert-danger" role="alert">
                <strong>Error:</strong> ${message}
                <button type="button" class="btn-close" onclick="$(this).parent().remove()"></button>
            </div>
        `;

                    // Thêm vào đầu form
                    $('#add_drug').prepend(errorDiv);

                    // Scroll lên đầu để người dùng thấy lỗi
                    $('html, body').animate({
                        scrollTop: $('#add_drug').offset().top - 100
                    }, 500);

                    // Tự động ẩn sau 5 giây
                    setTimeout(function () {
                        $('.error-message').fadeOut(500, function () {
                            $(this).remove();
                        });
                    }, 5000);
                }
            });
        </script>